---
title: "Validation"
author: "Matthew Phelps"
output:
  html_document:
    toc: true
    toc_float: true
    css: validation.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Set WD to be parent dir of folder containing rmd file
knitr::opts_knit$set(root.dir = normalizePath(".."))
library(data.table)
library(readxl)
library(ggplot2)
library(magrittr)

```

```{r}
source("r/validationFuncitons.R")
```

```{r, include = FALSE, warning= TRUE, cache=FALSE}

pop_reference <- fread("data/pop_age_10yr_dst.csv")
pop_ht <- fread("data/pop_summary_age.txt")
pop_ht6818 <- fread("data/pop_jan_summary_flat_6818.txt")

pop_sif <- fread("data/pop_age_10y_SIF.csv")

pop <- merge(
  pop_reference,
  pop_ht,
  by.x = c("sex", "age_group", "year"),
  by.y = c("sex", "grouping", "year"),
  suffixes = c(".dst", ".6322")
)

pop <- merge(
  pop,
  pop_ht6818,
  by.x = c("sex", "age_group", "year"),
  by.y = c("sex", "age_group", "year"),
  
)
setnames(pop, "N", "count.6818")

pop <- merge(
  pop,
  pop_sif,
  by.x = c("sex", "age_group", "year"),
  by.y = c("sex", "age_group", "year")
)
setnames(pop, "count", "count.sif")
# Find difference between StatistikBanken population and my population and SIF
```

```{r, cache=TRUE, cache.vars=c('pop_count', 'pop')}
pop[, diff_count6322 := count.6322 - count.dst]
pop[, diff_count6818 := count.6818 - count.dst]
pop[, diff_count_sif := count.sif - count.dst]
# pop[, diff_proportion := diff_count6322 / count.dst * 100]
# pop[, diff_proportion_sif := diff_count_sif / count.dst * 100]


# To long format for ggplot: (gives warning because some are Int, some are Num - can ignore)
pop_long <- melt(
  pop,
  id.vars = c("sex", "age_group", "year"),
  measure.vars = c(
    "diff_count6322",
    "diff_count6818",
    "diff_count_sif",
    "diff_proportion",
    "diff_proportion_sif"
  )
)
count_vars <- grep("diff_count", colnames(pop), value = TRUE)
pop_count <- pop_long[variable %in% count_vars, ]

# Not huge differences in population numbers
# pop[, range(diff_count)]
# pop[, range(diff_proportion)]
# 
# pop[, range(diff_count_sif)]
# pop[, range(diff_proportion_sif)]
# 
# pop[pop[, which.max(abs(diff_count))]]
# pop[pop[, which.max(abs(diff_proportion))]]
# head(pop[sex == "female"], 75)
# head(pop[sex == "male"], 75)

# To avoid caching issues

```


We look at the differences in data between SIF's HjerteTal and our new version


# Compare background population {.tabset .tabset-fade}

SIF has a *very* similar, but not exact background population as Statistikbanken (SB).  
See behistogram of differences between SB and HjereTal's populations for each unique sex/age/year grouping (i.e. women aged 35-44 in 2007....etc)

## Project 6322

Out HjerteTal usually has slightly more people in our population
```{r, cache=TRUE}

 
ggplot(pop_count[variable == "diff_count6322"]) +
  geom_histogram(aes(value, fill = variable), position = "identity", alpha = 0.5, binwidth = 100) +
  theme_classic() +
  xlab("Population difference")

# pop[, range(diff_count)]
# hist(pop[, diff_count], col = "darkred", main = "HjeteTal2")
# hist(pop[, diff_proportion])

```



## Project 6818

```{r, cache = TRUE}
ggplot(pop_count) +
  geom_histogram(aes(value, fill = variable), position = "identity", alpha = 0.5, binwidth = 100) +
  theme_classic() +
  xlab("Population difference")

```


## SIF's HT

```{r, cache = TRUE}

ggplot(pop_count) +
  geom_histogram(aes(value, fill = variable), position = "identity", alpha = 0.5, binwidth = 100) +
  theme_classic() +
  xlab("Population difference")
# 
# pop[, range(diff_count_sif)]
# hist(pop[, diff_count_sif], col = "darkblue", main = "SIF")
# hist(pop[, diff_proportion_sif])

# # Sum over age and sex for each year
# pop_year <-
#   pop[, .(count.dst = sum(count.dst),
#           count.ht = sum(count.ht)), by = year]
# pop_year[, count.diff := count.ht - count.dst]
# pop_year[, diff.proportion := (count.diff / count.dst) * 100]
# diff(pop_year$diff.proportion)
# pop_year[, range(diff.proportion)]
# 

```


## Across age groups (count)
Count of background population differences across age groups
```{r}
plot_age_pop(dat = pop[year == 2007 | year == 2014], diff_var = diff_count6322)

```

## Across age groups (prop)
Background population differences as proportion across age groups
```{r}
plot_age_pop(dat = pop[year == 2007 | year == 2014], diff_var = diff_proportion)

```



```{r, include = FALSE, cache=FALSE}

shiny_dat <- readRDS(file = "data/shiny_dat_dk.rds")
outcome_desc <-
  fread(file = "data/outcome_descriptions.csv", encoding = "UTF-8")
outcome_desc[, name_dk := tolower(name_dk)]

data_files <-
  list.files(
    "C:/Users/mphelps/Hjerteforeningen/Forskning - Old hjertetal data/udvikling/",
    full.names = TRUE
  )
dat_ht1 <- lapply(data_files, function(i) {
  read_xlsx(i) %>% setDT()
}) %>% rbindlist(use.names = FALSE)


data_files <-
  list.files(
    "C:/Users/mphelps/Hjerteforeningen/Forskning - Old hjertetal data/age/",
    full.names = TRUE
  )
dat_age <- lapply(data_files, function(i) {
  read_xlsx(i, skip = 2) %>% setDT()
}) %>% rbindlist(use.names = FALSE)

```




```{r, cache=FALSE}
setnames(dat_ht1, c("sex", "year", "count_ht1", "outcome", "variable"))

# Re-code variables in ht1 dataset
dat_ht1[sex == "Kvinder", sex := "female"]
dat_ht1[sex == "Mænd", sex := "male"]
dat_ht1[is.na(sex), sex := "Total"]
dat_ht1[, variable := tolower(variable) ]
dat_ht1[variable == "dødelighed", variable := "dead_year"]
dat_ht1[, variable := paste0("count_n_", variable)]
dat_ht1[, outcome := tolower(outcome)]
dat_ht1[, year := as.integer(year)]

dat_ht1 <-
  merge(dat_ht1, outcome_desc[, .(hjertetal_code, name_dk)], by.x = "outcome", by.y = "name_dk")


```


```{r cache = FALSE}
setnames(dat_age,
         c("sex", "grouping", "count_ht1", "year", "outcome", "variable"))

# Re-code variables
dat_age[is.na(sex), sex := "Total"]
dat_age[is.na(grouping), grouping := "Total"]
dat_age[sex == "Kvinder", sex := "female"]
dat_age[sex == "Mænd", sex := "male"]
dat_age[, outcome := tolower(outcome)]
dat_age[, variable := paste0("count_n_", variable)]
dat_age[, grouping := gsub("-", " - ", grouping)]
dat_age[, grouping := gsub(" år", "", grouping)]

dat_age <-
  merge(dat_age, outcome_desc[, .(hjertetal_code, name_dk)], by.x = "outcome", by.y = "name_dk")


```




```{r}
browser()
d1_prev <-
  data_diff_national(dat_ht1,
            shiny_dat,
            variable_str =  "count_n_prevalence",
            ht_code = "d1")

d1_dead_year <-
  data_diff_national(dat_ht1,
            shiny_dat,
            variable_str =  "count_n_dead_year",
            ht_code = "d1")

d1_incidence <-
  data_diff_national(dat_ht1,
            shiny_dat,
            variable_str =  "count_n_incidence",
            ht_code = "d1")

d1_incidence_age <-
  data_diff_age(dat_age,
                shiny_dat,
                variable_str = "count_n_incidence",
                ht_code = "d1")

d1_prev_age <-
  data_diff_age(dat_age,
                shiny_dat,
                variable_str = "count_n_prevalence",
                ht_code = "d1")



d9_prev <-
  data_diff_national(dat_ht1,
            shiny_dat,
            variable_str =  "count_n_prevalence",
            ht_code = "d9")
d9_incidence <-
  data_diff_national(dat_ht1,
            shiny_dat,
            variable_str =  "count_n_incidence",
            ht_code = "d9")

d9_incidence_age <-
  data_diff_age(dat_age,
                shiny_dat,
                variable_str = "count_n_incidence",
                ht_code = "d9")

d9_prev_age <-
  data_diff_age(dat_age,
                shiny_dat,
                variable_str = "count_n_prevalence",
                ht_code = "d9")

d9_dead_year <-
  data_diff_national(dat_ht1,
            shiny_dat,
            variable_str =  "count_n_dead_year",
            ht_code = "d9")


```



# Prevalence across time {.tabset .tabset-fade .tabset-pills}
## All-CVD {.tabset .tabset-fade}


We overestimate All-CVD prevalence

### Counts
```{r, cache=FALSE}



plot_national(d1_prev, diff_var = diff_count)
```

### Proportion

```{r}
plot_national(d1_prev, diff_var = diff_prop)
```


## Iskæmisk hjertesygdom {.tabset .tabset-fade}
We overestimate Iskæmisk hjertesygdom prevalence

### Counts
```{r, cache=FALSE}



plot_national(d9_prev, diff_var = diff_count)
```

### Proportion

```{r}
plot_national(d9_prev, diff_var = diff_prop)
```





# Incidence across time {.tabset .tabset-fade .tabset-pills}
However, the difference in incidence is not consistent:

## All-CVDs {.tabset .tabset-fade}
### Counts
```{r cache = FALSE}
plot_national(d1_incidence, diff_var = diff_count)
```

### Proportion
```{r cache = FALSE}
plot_national(d1_incidence, diff_var = diff_prop)
```


## Iskæmisk hjertesygdom {.tabset .tabset-fade}
### Counts
```{r cache = FALSE}
plot_national(d9_incidence, diff_var = diff_count)
```

### Proportion
```{r cache = FALSE}
plot_national(d9_incidence, diff_var = diff_prop)
```



# Mortality across time {.tabset .tabset-fade .tabset-pills}
How many people died due to the illness in each year

## All-CVDs {.tabset .tabset-fade}
### Counts
```{r cache = FALSE}
plot_national(d1_dead_year, diff_var = diff_count)
```

### Proportion
```{r cache = FALSE}
plot_national(d1_dead_year, diff_var = diff_prop)
```


## Iskæmisk hjertesygdom {.tabset .tabset-fade}
### Counts
```{r cache = FALSE}
plot_national(d9_dead_year, diff_var = diff_count)
```

### Proportion
```{r cache = FALSE}
plot_national(d9_dead_year, diff_var = diff_prop)
```






# Prevalence across age-groups  {.tabset .tabset-fade .tabset-pills}
## All-CVDs {.tabset .tabset-fade}
### Counts
```{r}
plot_age(d1_prev_age, diff_var = diff_count)
```

### Proportions
```{r}
plot_age(d1_prev_age, diff_var = diff_prop)
```



## Iskæmisk hjertesygdom {.tabset .tabset-fade}
### Counts
```{r}
plot_age(d9_prev_age, diff_var = diff_count)
```

### Proportions
```{r}
plot_age(d9_prev_age, diff_var = diff_prop)
```






# Incidence across age-groups  {.tabset .tabset-fade .tabset-pills}
## All-CVDs {.tabset .tabset-fade}
### Counts
```{r}
plot_age(d1_incidence_age, diff_var = diff_count)
```

### Proportions
```{r}
plot_age(d1_incidence_age, diff_var = diff_prop)
```



## Iskæmisk hjertesygdom {.tabset .tabset-fade}
### Counts
```{r}
plot_age(d9_incidence_age, diff_var = diff_count)
```

### Proportions
```{r}
plot_age(d9_incidence_age, diff_var = diff_prop)
```

